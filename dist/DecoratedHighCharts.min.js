function aggregate(dataToAgg,y){var aggFnMap={SUM:ss.sum,AVERAGE:ss.average,COUNT:function(x){return _.uniq(x).length}},dataArray=_.pluck(dataToAgg,y.colTag),aggFn=aggFnMap[y.aggregationMethod];return aggFn(dataArray)}var TURBO_THRESHOLD=2e3;angular.module("decorated-high-charts").factory("chartDataUniverse",function(){return{data:[],getSelectedRowsData:function(){},scatterPlotPointClickCallback:function(){},setupUniverse:function(pScope){this.data=pScope.data,this.getSelectedRowsData=pScope.getSelectedRowsData||this.getSelectedRowsData,this.scatterPlotPointClickCallback=pScope.scatterPlotPointClickCallback||this.scatterPlotPointClickCallback,this.key=pScope.key}}}),angular.module("decorated-high-charts").factory("chartFactory",function(boxPlotProvider,scatteredChartProvider,pieChartProvider,heatMapProvider,columnChartProvider){var chartFactoryMap={"Box Plot":boxPlotProvider,"Scattered Plot":scatteredChartProvider,"Pie Chart":pieChartProvider,"Column Chart":columnChartProvider};return{getHighchartOptions:function(chartProperties,onlyOnSelectedRows){return chartFactoryMap[chartProperties.type].produceChartOption(chartProperties,onlyOnSelectedRows)},getRelevantProperties:function(chartProperties){return"Pie Chart"===chartProperties.type||"Box Plot"===chartProperties.type?["group_by","analytic"]:"Scattered Plot"===chartProperties.type?["x_attribute","y_attribute","radius","group_by"]:"Column Chart"===chartProperties.type?["x_attribute","y_attribute","group_by"]:void 0},regressionTypes:[{tag:"linear",text:"Linear"},{tag:"polynomial",text:"Polynomial"},{tag:"logarithmic",text:"Logarithmic"},{tag:"exponential",text:"Exponential"}]}}),angular.module("decorated-high-charts").factory("pieChartProvider",function(chartDataUniverse,commonHighchartConfig){var cfgTemplate=_.extend(_.clone(commonHighchartConfig),{chart:{type:"pie",marginTop:40},plotOptions:{pie:{dataLabels:{formatter:function(){return"null"==this.point.name?"N/A":this.point.name}}}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b>: "+this.point.name+"<br/><b>Percent of Pie</b>: "+numeral(this.percentage).format("0,0.00")+"%<br/><b>Total for Slice</b>: "+numeral(this.y/1e3).format("0,0")+"<br/><b>Total for Pie</b>: "+numeral(this.total/1e3).format("0,0")},pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}}}});return{produceChartOption:function(chartProperties,onlyOnSelectedRows){var toGroupBy=chartProperties.group_by.colTag,groupedAnalytic=_.groupBy(onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data,toGroupBy),categories=_.keys(groupedAnalytic),pieSeries=[],data=[];_.each(categories,function(category){var value=aggregate(groupedAnalytic[category],chartProperties.analytic),dataPoint={name:category,y:value};data.push(dataPoint)}),pieSeries.push({name:chartProperties.group_by.text,data:data});var cfg=_.clone(cfgTemplate);return categories.length<10?cfg.series=pieSeries:cfg.subtitle={text:"* Too Many Slices of Pie to Display from Grouping by "+chartProperties.group_by.text+" *"},cfg.title.text=chartProperties.group_by.text+" weighted by "+chartProperties.analytic.text,cfg}}}),angular.module("decorated-high-charts").factory("boxPlotProvider",function(chartDataUniverse,commonHighchartConfig){var cfgTemplate=_.extend(_.clone(commonHighchartConfig),{chart:{type:"boxplot",marginTop:40},title:{text:null},tooltip:{valueDecimals:2},legend:{enabled:!1},plotOptions:{},xAxis:{labels:{formatter:function(){return"null"==this.value?"N/A":this.value}}},yAxis:{title:{text:null}},series:null,credits:{enabled:!1}});return{produceChartOption:function(chartProperties,onlyOnSelectedRows){var toGroupBy=chartProperties.group_by.colTag,analytic=chartProperties.analytic.colTag,groupedAnalytic=_.groupBy(onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data,toGroupBy),categories=_.keys(groupedAnalytic),boxPlotData=[];_.each(categories,function(category){var data=_.pluck(groupedAnalytic[category],analytic);boxPlotData.push([ss.min(data),ss.quantile(data,.25),ss.median(data),ss.quantile(data,.75),ss.max(data)])});var boxPlotSeries={name:chartProperties.analytic.text,data:boxPlotData},cfg=_.clone(cfgTemplate);return cfg.xAxis.categories=categories,cfg.yAxis.title.text=chartProperties.analytic.text,categories.length<15?cfg.series=[boxPlotSeries]:cfg.subtitle={text:"* Too Many Boxes to Display from Grouping by "+chartProperties.group_by.text+" *"},cfg.title.text=chartProperties.analytic.text+" by "+chartProperties.group_by.text,cfg}}}),angular.module("decorated-high-charts").factory("scatteredChartProvider",function(chartDataUniverse,dhcStatisticalService,commonHighchartConfig,dhcSeriesColorService){function generateSeries(categories,radius,groupedData,xAttr,yAttr,stdevForOutlierRemoval,propertiesHash){var series=[];return _.each(categories,function(category){var data=[];null!=radius?_.each(groupedData[category],function(item){null!=item[xAttr.colTag]&&item[yAttr.colTag]&&data.push({id:item[chartDataUniverse.key],name:item[chartDataUniverse.key],x:item[xAttr.colTag],y:item[yAttr.colTag],z:item[radius.colTag]})}):_.each(groupedData[category],function(item){null!=item[xAttr.colTag]&&item[yAttr.colTag]&&data.push({id:item[chartDataUniverse.key],name:item[chartDataUniverse.key],x:item[xAttr.colTag],y:item[yAttr.colTag]})}),data=data.sort(function(a,b){return a.x-b.x});var result=processData(chartDataUniverse.data,stdevForOutlierRemoval,xAttr,yAttr),serObj={name:"null"==category?"Not Found":category,tooltip:{pointFormat:'<span style="color:{series.color}">{point.name}</span><br/><b>'+xAttr.text+"</b>: {point.x:,.2f} <br/><b>"+yAttr.text+"</b>: {point.y:,.2f}<br/><br/><b>"+xAttr.text+" &mu;</b>:"+numeral(result.xMean.toFixed(2)).format("0,0.00")+"<br/><b>"+yAttr.text+" &mu;</b>:"+numeral(result.yMean.toFixed(2)).format("0,0.00")+"<br/><br/><b>"+xAttr.text+" &sigma;</b>:"+numeral(result.xStdev.toFixed(2)).format("0,0.00")+"<br/><b>"+yAttr.text+" &sigma;</b>:"+numeral(result.yStdev.toFixed(2)).format("0,0.00")},data:data,marker:{symbol:"circle",states:{select:{lineColor:null}}},color:null};const seriesColor=dhcSeriesColorService.getOrAssign("chart"+propertiesHash,serObj.name);serObj.color=seriesColor,serObj.marker.states.select.lineColor=seriesColor,series.push(serObj)}),series}function addFittedLine(series,chartId){var index=0;return _.each(series,function(currentSeries){var regressionOutput=dhcStatisticalService.getLinearFit(currentSeries.data),color=dhcSeriesColorService.get("chart"+chartId,currentSeries.name);series.push({name:currentSeries.name+" Regression (Linear)",marker:{enabled:!1},type:"line",showInLegend:!1,enableMouseTracking:!1,color:color,data:regressionOutput.predictedValue}),index++}),series}function regressionJSWrapper(series,type,extraArgs,chartId){var index=0;return _.each(series,function(currentSeries){if(!(currentSeries.data.length<=1)){var regressionOutput=dhcStatisticalService.regressionJSWrapper(currentSeries.data,type,extraArgs),color=dhcSeriesColorService.get("chart"+chartId,currentSeries.name);series.push({name:currentSeries.name+" Regression ("+type+")",marker:{enabled:!1},type:"spline",showInLegend:!1,enableMouseTracking:!1,color:color,data:regressionOutput.predictedValue}),index++}}),series}function processData(data,stdevForOutlierRemoval,xAttr,yAttr){var filteredData,yData=_.chain(data).pluck(yAttr.colTag).compact().value(),xData=_.chain(data).pluck(xAttr.colTag).compact().value(),xMean=ss.mean(xData),xStdev=ss.standard_deviation(xData),yMean=ss.mean(yData),yStdev=ss.standard_deviation(yData);return filteredData=stdevForOutlierRemoval?_.filter(data,function(datum){var xCutoff=Math.abs(xMean-datum[xAttr.colTag]),yCutoff=Math.abs(yMean-datum[yAttr.colTag]);return stdevForOutlierRemoval*xStdev>xCutoff&&stdevForOutlierRemoval*yStdev>yCutoff}):data,{data:filteredData,xMean:xMean||0,yMean:yMean||0,xStdev:xStdev||0,yStdev:yStdev||0}}var cfgTemplate=_.extend(_.clone(commonHighchartConfig),{chart:{type:"scatter",zoomType:"xy",marginTop:40},legend:{enabled:!0},title:{text:null},xAxis:{title:{text:null,margin:0}},yAxis:{title:{text:null,margin:5}},series:[],credits:{enabled:!1}});return{addRegression:function(series,type,extraArgs,id){return type?regressionJSWrapper(series,type,extraArgs,id):addFittedLine(series,id)},removeRegression:function(series){for(var i=0;i<series.chart.series.length;i++)if(series.color==series.chart.series[i].color&&series.chart.series[i].name.match("Regression")){series.chart.series[i].remove();break}},redrawRegression:function(series,chartProperties){if(this.removeRegression(series),series.data.length>1)if("linear"===chartProperties.regression){var regressionOutput=dhcStatisticalService.getLinearFit(series.data),color=dhcSeriesColorService.get("chart"+chartProperties.$$hashKey,series.name);series.chart.addSeries({name:series.name+" Regression (Linear)",marker:{enabled:!1},type:"line",showInLegend:!1,enableMouseTracking:!1,color:color,data:regressionOutput.predictedValue})}else if(null!=chartProperties.regression&&""!=chartProperties.regression){var extraArg="polynomial"===chartProperties.regression?chartProperties.regression_degree:null,regressionOutput=dhcStatisticalService.regressionJSWrapper(series.data,chartProperties.regression,extraArg),color=dhcSeriesColorService.get("chart"+chartProperties.$$hashKey,series.name);series.chart.addSeries({name:series.name+" Regression ("+chartProperties.regression+")",marker:{enabled:!1},type:"spline",showInLegend:!1,enableMouseTracking:!1,color:color,data:regressionOutput.predictedValue})}},produceChartOption:function(chartProperties,onlyOnSelectedRows){dhcSeriesColorService.removePalate("chart"+chartProperties.$$hashKey);var data,xAttr=chartProperties.x_attribute,yAttr=chartProperties.y_attribute,radius=chartProperties.radius,groupByAttr=chartProperties.group_by,series=[],cfg=_.clone(cfgTemplate),groupedData={};if((onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data).length<=TURBO_THRESHOLD){var result=processData(onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data,chartProperties.outlier_remove,xAttr,yAttr),data=result.data;null!=groupByAttr?groupedData=_.groupBy(data,groupByAttr.colTag):groupedData[chartProperties.x_attribute.text]=data;var categories=_.keys(groupedData);if(series=generateSeries(categories,radius,groupedData,xAttr,yAttr,chartProperties.outlier_remove,chartProperties.$$hashKey),"linear"===chartProperties.regression)addFittedLine(series,chartProperties.$$hashKey);else if(null!=chartProperties.regression&&""!=chartProperties.regression){var extraArg="polynomial"===chartProperties.regression?chartProperties.regression_degree:null;regressionJSWrapper(series,chartProperties.regression,extraArg,chartProperties.$$hashKey)}}else cfg.subtitle={text:"* Too Many Data Points to Plot - (Future Versions will Implement Random Sampling and Drilldown Features) *"};return null!=radius?cfg.chart.type="bubble":cfg.chart.type="scatter",series.length>10?cfg.subtitle={text:"* Too Many Series to Plot *"}:cfg.series=series,cfg.legend.enabled=_.reject(series,function(ser){return"spline"===ser.type}).length>1,cfg.xAxis.title.text=xAttr.text,cfg.yAxis.title.text=yAttr.text,cfg.title.text=xAttr.text+" vs. "+yAttr.text,cfg.plotOptions={series:{point:{events:{click:function(){chartDataUniverse.scatterPlotPointClickCallback&&chartDataUniverse.scatterPlotPointClickCallback()}}}}},cfg.tooltip.hideDelay=0,chartProperties.show_datalabel?cfg.plotOptions[cfg.chart.type]={dataLabels:{allowOverlap:!1,enabled:!0,formatter:function(){return this.point.name}}}:delete cfg.plotOptions[cfg.chart.type],cfg}}}),angular.module("decorated-high-charts").factory("heatMapProvider",function(chartDataUniverse,commonHighchartConfig){var cfgTemplate=_.extend(_.clone(commonHighchartConfig),{chart:{type:"heatmap",marginTop:40,marginBottom:40},colorAxis:{min:0,minColor:Highcharts.getOptions().colors[3],maxColor:Highcharts.getOptions().colors[0]},yAxis:{title:{text:null},showEmpty:!1},xAxis:{title:{text:null},showEmpty:!1},legend:{align:"right",layout:"vertical",margin:0,verticalAlign:"top",y:25,symbolHeight:320},tooltip:{formatter:function(){return"<b>"+this.series.xAxis.categories[this.point.x]+"</b> sold <br><b>"+this.point.value+"</b> items on <br><b>"+this.series.yAxis.categories[this.point.y]+"</b>"}}});return{produceChartOption:function(chartProperties,onlyOnSelectedRows){function aggregate(groupData,chartProperties){for(var dataArray=_.pluck(groupData,chartProperties.analytic.colTag),sum=0,i=0;i<dataArray.length;i++)sum+=dataArray[i];return sum}for(var xAttr=chartProperties.x_attribute,yAttr=chartProperties.y_attribute,xCategories=_.uniq(_.pluck(onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data,xAttr.colTag)),yCategories=_.uniq(_.pluck(onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data,yAttr.colTag)),data=[],i=0;i<xCategories.length;i++)for(var j=0;j<yCategories.length;j++){var groupData=_.filter(onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data,function(data){return data[xAttr.colTag]==xCategories[i]&&data[yAttr.colTag]==yCategories[j]}),aggregatedData=aggregate(groupData,chartProperties);data.push([i,j,aggregatedData])}var series={name:"Test",data:data,borderWidth:1,dataLabels:{enabled:!0,color:"black",style:{textShadow:"none",HcTextStroke:null}}},cfg=_.clone(cfgTemplate);return cfg.series=[series],cfg.xAxis.categories=xCategories,cfg.yAxis.categories=yCategories,cfg}}}),angular.module("decorated-high-charts").factory("commonHighchartConfig",function($rootScope){$.extend(Highcharts.Renderer.prototype.symbols,{X:function(a,b,c,d){return["M",a,b,"L",a+c,b+d,"M",a+c,b,"L",a,b+d]}});var commonCfg={chart:{animation:!1,marginTop:-12,events:{load:function(){for(var i=0;i<this.exportSVGElements.length;i++)this.exportSVGElements[i].toFront()}}},title:{text:""},plotOptions:{series:{turboThreshold:TURBO_THRESHOLD}},exporting:{enabled:!1},tooltip:{valueDecimals:2,useHTML:!0,delayForDisplay:1e3},credits:{enabled:!1},xAxis:{tickInterval:1,minPadding:0,maxPadding:0},yAxis:{tickInterval:1,minPadding:0,maxPadding:0}};return _.clone(commonCfg)}),angular.module("decorated-high-charts").factory("columnChartProvider",function(chartDataUniverse,commonHighchartConfig){var cfgTemplate=_.extend(_.clone(commonHighchartConfig),{chart:{type:"column"},xAxis:{title:{text:null},showEmpty:!1},yAxis:{title:{text:null},showEmpty:!1},plotOptions:{column:{pointPadding:.2,borderWidth:0}}});return{produceChartOption:function(chartProperties,onlyOnSelectedRows){var x=chartProperties.x_attribute,y=chartProperties.y_attribute,groupedAnalytic={};chartProperties.group_by?groupedAnalytic=_.groupBy(onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data,chartProperties.group_by.colTag):groupedAnalytic[x.text]=onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data;var categories=_.keys(groupedAnalytic),xValues=_.uniq(_.pluck(onlyOnSelectedRows?chartDataUniverse.getSelectedRowsData():chartDataUniverse.data,x.colTag)),series=[];_.each(categories,function(category){var categoryData=groupedAnalytic[category],data=_.map(xValues,function(xValue){var toAggregate=_.filter(categoryData,function(item){return item[x.colTag]==xValue});return aggregate(toAggregate,y)});category="null"==category?"N/A "+chartProperties.group_by.text:category,series.push({name:category,data:data})});var cfg=_.clone(cfgTemplate);return categories.length*series.length<50?cfg.series=series:cfg.subtitle={text:"* Too Many Bars to Display *"},xValues=_.map(xValues,function(item){return null==item?"N/A "+chartProperties.x_attribute.text:item}),cfg.xAxis.categories=xValues,cfg.yAxis.title.text=y.unit,cfg.title.text=y.text+" by "+x.text,cfg}}}),angular.module("decorated-high-charts").factory("dhcSeriesColorService",function(){const colors=["#0079C1","#009A3D","#6C207E","#E31B23","#F8971D","#FFD200","#59BD81","#59A7D7","#9F6FAA","#ED6B70","#FABB6B","#FFE159","#325CBA","#3CB54B","#092A59","#BB4B31","#32A0BA","#B98F2F","#849DD0","#8DCC92","#6C809C","#85C6D5","#D69383","#D5BC81","#C9D4ED","#ADBEE2","#B3DBB6","#787878","#9DAABD","#ADD9E3","#E4B7AD","#E3D3AC","#A1B5DD","#D8ECDA","#555555","#CEBDDE","#D6ECF1","#F1DBD5","#5474B9"];return{palate:colors,altPalate:angular.copy(colors).reverse(),fullPalate:{},get:function(palateName,key){return this.fullPalate[palateName]&&this.fullPalate[palateName][key]?this.fullPalate[palateName][key]:null},put:function(palateName,key,color){this.fullPalate[palateName]||(this.fullPalate[palateName]={}),this.fullPalate[palateName][key]=color},remove:function(palateName,key){this.fullPalate[palateName]&&this.fullPalate[palateName][key]&&delete this.fullPalate[palateName][key]},removePalate:function(palateName){this.fullPalate[palateName]&&delete this.fullPalate[palateName]},assign:function(palateName,key,useAltPalate){this.fullPalate[palateName]||(this.fullPalate[palateName]={});const palateToUse=useAltPalate?this.altPalate:this.palate;var indexToUse=Object.keys(this.fullPalate[palateName]).length;return this.put(palateName,key,palateToUse[indexToUse%palateToUse.length]),palateToUse[indexToUse]},getOrAssign:function(palateName,key,useAltPalate){var color=this.get(palateName,key);return color?color:this.assign(palateName,key,useAltPalate)},resetPalate:function(){this.fullPalate={}}}}),angular.module("decorated-high-charts").factory("dhcStatisticalService",function(){return{getLinearFit:function(data){var dataArray=_.map(data,function(point){return[point.x,point.y]});if(0!=dataArray.length){var regression=ss.linear_regression().data(dataArray),cols=_.zip.apply(_,dataArray),correlation=ss.sample_correlation(cols[0],cols[1]),linearFn=regression.line(),predictedValue=_.map(dataArray,function(pt){return[pt[0],linearFn(pt[0])]});return{predictedValue:predictedValue,beta:regression.m(),intercept:regression.b(),correlation:correlation}}return{predictedValue:[],beta:0,intercept:0,correlation:0}},regressionJSWrapper:function(data,type,extraArg){var dataArray=_.map(data,function(datum){return[datum.x,datum.y]});if(0!=dataArray.length){const scrubbedData=_.filter(dataArray,function(row){return row[0]&&row[0]});var regressionOutput=regression(type,scrubbedData,extraArg),predictedValue=regressionOutput.points;return predictedValue.sort(function(a,b){return a[0]-b[0]}),{predictedValue:predictedValue,equation:regressionOutput.string}}return{predictedValue:[],equation:""}}}}),function(){"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(suffix){return-1!==this.indexOf(suffix,this.length-suffix.length)}),Date.prototype.getYYYYMMDD=function(){var month=this.getMonth()+1;month=1==month.toString().length?"0"+month:month;var day=this.getDate();return day=1==day.toString().length?"0"+day:day,this.getFullYear()+"-"+month+"-"+day};const $script=$("script[src]"),src=$script[$script.length-1].src,scriptFolder=src.substr(0,src.lastIndexOf("/")+1);angular.module("decorated-high-charts",["ui.bootstrap","typeahead-focus"]),angular.module("decorated-high-charts").directive("decoratedHighCharts",function(chartDataUniverse,chartFactory,$timeout){return{restrict:"E",scope:{chartProperties:"=",data:"=",key:"@",numericalColumns:"=",categoricalColumns:"=",customButtons:"=?",apiHandle:"=",getSelectedRowsData:"&?",showOnlySelectedRows:"=?",scatterPlotPointClickCallback:"&?",title:"@?",highchartOptions:"=?"},controller:function($scope,$element){chartDataUniverse.setupUniverse($scope),_.each(chartFactory.getRelevantProperties($scope.chartProperties),function(property){$scope.chartProperties[property]=$scope.chartProperties[property]?_.findWhere($scope.numericalColumns.concat($scope.categoricalColumns),{colTag:$scope.chartProperties[property].colTag}):void 0})},link:function(scope,elem,attrs){scope.chartId=_.uniqueId("decorated-highchart-"),scope.chartFactory=chartFactory,scope.alerts={generalWarning:{active:!1,message:""}},scope.states={menuDisplays:{moreOptions:!1}},scope.toggleSlide=function(show,className){const camelCaseName=attrs.$normalize(className);scope.states.menuDisplays[camelCaseName]=show;var $ctrl=elem.find("."+className);show?($ctrl.slideDown(500),$ctrl.find("input").first().select()):$ctrl.slideUp(500),$timeout(function(){})},scope.getRegressionText=function(){return scope.chartProperties.regression?_.findWhere(chartFactory.regressionTypes,{tag:scope.chartProperties.regression}).text:"No Regression"},scope.exportXLS=function(){var html=dhc.seriesToHTML(scope.states.chart.series);window.navigator.msSaveBlob?window.navigator.msSaveBlob(new Blob([html]),"time-series-export.xls"):window.open("data:application/vnd.ms-excel,"+encodeURIComponent(html))},scope.apiHandle.api={loadChart:function(){var opts=chartFactory.getHighchartOptions(scope.chartProperties,scope.showOnlySelectedRows);opts.chart.renderTo=scope.chartId,scope.states.chart=new Highcharts.Chart(opts)},timeoutLoadChart:function(){$timeout(function(){scope.apiHandle.api.loadChart()})}},$timeout(function(){scope.apiHandle.api.loadChart()})},templateUrl:scriptFolder.endsWith("src/")?scriptFolder+"/templates/DecoratedHighCharts.html":"DecoratedHighCharts.html"}}).directive("dhcClickOutside",function(){return{restrict:"A",scope:{openState:"=dhcOpenState",closeCallback:"&dhcCloseCallback"},link:function(scope,element){var clickedOutside=!0;const documentClickHandler=function(){clickedOutside&&scope.openState&&scope.closeCallback(),clickedOutside=!0};$(document).click(documentClickHandler);const elementClickHandler=function(){clickedOutside=!1};element.click(elementClickHandler),scope.$on("$destroy",function(){$(document).unbind("click",documentClickHandler),element.unbind("click",elementClickHandler)})}}})}(),function(){const root=this,dsc=root.dsc||{};root.dsc=dsc,dsc.seriesToHTML=function(series){const headers="<tr><th style='background-color: #0069d6; color: #ffffff;'>Date</th>"+_.map(series,function(s){return"<th style='background-color: #0069d6; color: #ffffff;'>"+s.name+"</th>"}).join("")+"</tr>",domain=_.chain(series).map(function(s){return _.map(s.data,function(datum){return datum.x})}).flatten().uniq().value(),matrix=_.map(series,function(s){return _.chain(s.data).map(function(datum){return[datum.x,datum.y]}).object().value()}),body=_.map(domain,function(x){return"<tr><td style='background-color: #999999'>"+moment(x).format("YYYY-MM-DD")+"</td>"+_.map(matrix,function(col){return"<td>"+(col[x]&&void 0!==col[x]&&"undefined"!==col[x]?col[x]:0)+"</td>"}).join("")+"</tr>"}).join("\n");return"<table>"+headers+body+"</table>"}}(),function(){const root=this,dhc=root.dhc||{};root.dhc=dhc,root.dhc.resolvePreferredYAxis=function(chart,seriesOption){return seriesOption.axisType?_.findIndex(chart.yAxis,function(axis){return axis.userOptions.axisType===seriesOption.axisType}):0===chart.yAxis.length?-1:0},root.dhc.addAxisToChart=function(chart,name,scope,axisType){const axisId=_.uniqueId("yAxis");return chart.addAxis({title:{text:name,events:{click:function(event){dhc.onAxisClick.call(this,event,scope)}}},axisType:axisType,opposite:chart.axes.length%2==0,id:axisId}),chart.get(axisId)},root.dhc.attachLegendEventHandlers=function(series,scope){$(series.legendItem.element).css({"user-select":"none"}).mousedown(function(event){return 2==event.button?(event.preventDefault(),event.stopPropagation(),dhc.triggerSeriesContextMenu(event,{series:series,scope:scope})):void 0})},root.dhc.onAxisClick=function(event,scope){function removeAxis(){return $("<li><a><i class='fa fa-remove'></i>&nbsp;Remove Axis</a></li>").click(function(){for(;axis.series&&0!==axis.series.length;)scope.removeSeries(axis.series[0]);axis.remove()})}function editAxisTitle(){const $input=$("<input type='text' class='form-control' style='position:relative; left: 10%; width: 80%;'/>");$input.val(axis.axisTitle.textStr),$input.on("keydown",function(keyEvent){13==keyEvent.keyCode&&""!=$input.val()&&(keyEvent.preventDefault(),keyEvent.stopPropagation(),axis.setTitle({text:$input.val()}),$ctxMenu.hide())});const $menuItem=$("<li><span></span></li>").click(dhc.inertClickHandler);return $menuItem.children("span").append($input),$menuItem}event.preventDefault(),event.stopPropagation();const axis=this,$ctxMenu=scope.$ctxMenu;$ctxMenu.find(".dropdown-menu li").remove(),$ctxMenu.children(".dropdown-menu").append(editAxisTitle()).append(removeAxis()),dhc.showCtxMenu($ctxMenu,event),$ctxMenu.find("input.form-control").select()},root.dhc.showCtxMenu=function($ctxMenu,event){$ctxMenu.show();const $rootDiv=$("div.root"),ctnRight=$rootDiv.position().left+$rootDiv.width(),menuRight=event.clientX+$ctxMenu.children().width(),ctnBtm=$rootDiv.position().top+$rootDiv.height(),menuBtm=event.clientY+$ctxMenu.children().height();var left=event.clientX;menuRight>ctnRight&&(left=Math.max(event.clientX-$ctxMenu.children().width(),0));var top=event.clientY;menuBtm>ctnBtm&&(top=event.clientY-$ctxMenu.children().height()),$ctxMenu.css({top:top+"px",left:left+"px"})},root.dhc.inertClickHandler=function(e){e.preventDefault(),e.stopPropagation()},root.dhc.moveAxis=function(series,targetAxis,scope){const origAxis=series.yAxis,seriesOptions=series.options;seriesOptions.yAxis=_.findIndex(scope.states.chart.yAxis,function(x){return x.userOptions.id==targetAxis.userOptions.id}),seriesOptions.color=series.color,series.remove(),scope.addSeries(seriesOptions),dhc.isAxisEmpty(origAxis)&&origAxis.remove()},root.dhc.generateSeriesID=function(security,attr){return["Security",security.id,attr.tag].join(".")},root.dhc.onTitleClick=function(clickEvent,scope,chart){const $input=$("<input class='form-control' style='position:relative; left: 5%; width: 90%;'/>"),$menuItem=$("<li><span></span></li>");$menuItem.on("click",dhc.inertClickHandler).children("span").append($input);const $ctxMenu=scope.$ctxMenu;$ctxMenu.find(".dropdown-menu li").remove(),$ctxMenu.children(".dropdown-menu").append($menuItem),$input.on("keydown",function(keyEvent){13==keyEvent.keyCode&&""!=$input.val()?(keyEvent.preventDefault(),keyEvent.stopPropagation(),chart.setTitle({text:$input.val()}),$ctxMenu.hide()):27==keyEvent.keyCode&&$ctxMenu.hide()}).val(chart.options.title.text);const titleLength=Math.min($input.val().length,20);$menuItem.css({"min-width":titleLength+"em"}),dhc.showCtxMenu($ctxMenu,clickEvent),$input.select()},root.dhc.isAxisEmpty=function(yAxis){return yAxis&&0===yAxis.series.length},root.dhc.afterSeriesRemove=function(yAxis,securityId,scope){function hasNoSeries(securityId){const chart=scope.states.chart;return 0===_.filter(chart.series,function(series){return series.userOptions.securityId&&series.userOptions.securityId===securityId}).length}dhc.isAxisEmpty(yAxis)&&yAxis.remove(),securityId&&hasNoSeries(securityId)&&scope.apiHandle.api.removeSecurity(securityId)},root.dhc.removeSeriesById=function(id,scope){const chart=scope.states.chart,series=chart.get(id),yAxis=series.yAxis,securityId=series.options.securityId;angular.isFunction(series.remove)&&series.remove(),dhc.afterSeriesRemove(yAxis,securityId,scope)},root.dhc.SMAFactory=function(period){var nums=[];return function(num){nums.push(num),nums.length>period&&nums.splice(0,1);var sum=0;for(var i in nums)sum+=nums[i];var n=period;return nums.length<period&&(n=nums.length),sum/n}}}(),function(){const root=this,dsc=root.dsc||{};root.dsc=dsc,root.dsc.buildContextMenuContainer=function(elem){const $ctxMenu=$("<div style='z-index: 10; position: fixed;'><ul class='clickable dropdown-menu multi-level' style='display: block;'></ul></div>").hide();return $ctxMenu.prependTo(elem.children(".root")),$(window).click(function(){$ctxMenu.hide()}),$ctxMenu},root.dsc.triggerSeriesContextMenu=function(event,args){const $ctxMenu=args.scope.$ctxMenu;return $ctxMenu.find(".dropdown-menu li").remove(),_.each(dsc.buildMenuItems(args),function(menuItem){$ctxMenu.children(".dropdown-menu").append(menuItem)}),dsc.showCtxMenu($ctxMenu,event),!1},root.dsc.buildMenuItems=function(args){function transformerMenuItemGenerator(transformFn,text){const $input=$("<input type='text' placeholder='Day(s)' class='form-control' style='position: relative; width: 80%; left: 10%;'/>");return $("<li class='dropdown-submenu'><a>"+text+"</a></li>").click(function(e){e.preventDefault(),e.stopPropagation(),$input.focus()}).append($("<li class='dropdown-menu'><span></span></li>").click(dsc.inertClickHandler).append($input.on("keydown",function(keyEvent){if(13==keyEvent.keyCode){if(isNaN(parseInt($input.val()))||""==$input.val())return;const transformedSeries=transformFn(series,parseInt($input.val()));transformedSeries.disableFurtherTransformation=!0,scope.addSeries(transformedSeries),scope.$ctxMenu.hide()}})))}function changeType(){const $subMenu=$("<ul class='dropdown-menu'></ul>");return _.chain([["Line","spline","line-chart"],["Area","areaspline","area-chart"],["Column","column","bar-chart"]]).filter(function(type){return type[1]!==series.type}).each(function(type){$("<li><a><i class='fa fa-"+type[2]+"'></i>&nbsp;"+type[0]+"</a></li>").click(function(){series.update({type:type[1]}),dsc.attachLegendEventHandlers(series,scope)}).appendTo($subMenu)}),$("<li class='dropdown-submenu'><a>Change Chart Type</a></li>").append($subMenu)}const scope=args.scope,seriesTransformer=scope.seriesTransformer,series=args.series,disableTransformation=series.options.disableFurtherTransformation,chart=scope.states.chart,addMA=transformerMenuItemGenerator.bind(null,seriesTransformer.toSimpleMA,"Add Simple MA"),basis=function(){return $("<li class='dropdown-submenu'><a>Show Basis vs. </a></li>").append(dsc.buildSeriesSubMenu({scope:scope,onClick:function(event,otherSeries){const transformedSeries=seriesTransformer.toBasis(series,otherSeries);scope.addSeries(transformedSeries)},currentSeries:series}))},removeSeries=function(){return $("<li><a>Remove</a></li>").click(function(){scope.$apply(function(){scope.removeSeries(series)})})},changeAxis=function(){return $("<li class='dropdown-submenu'><a>Change Axis</a></li>").append(dsc.buildAxesSubMenu(series,chart,scope))};return disableTransformation?[changeAxis(),basis(),changeType(),removeSeries()]:[changeAxis(),addMA(),basis(),changeType(),removeSeries()]},root.dsc.buildSeriesSubMenu=function(args){const chart=args.scope.states.chart,callback=args.onClick,currentSeries=args.currentSeries,$subMenu=$("<ul class='dropdown-menu'></ul>"),filteredSeries=_.filter(chart.series,function(series){return currentSeries&&series.options.id!==currentSeries.options.id});return 0==filteredSeries.length?$subMenu.append("<li><a>No Other Series to Compare To</a></li>"):_.each(filteredSeries,function(series){$("<li><a>"+series.name+"</a></li>").click(function(event){callback(event,series)}).appendTo($subMenu)}),$subMenu},root.dsc.buildAxesSubMenu=function(series,chart,scope){const $dropdown=$("<ul class='dropdown-menu'></ul>");return _.each(chart.yAxis,function(axis){var $menuItem;$menuItem=axis.userOptions.id===series.yAxis.userOptions.id?$("<li><a>Y-Axis: "+axis.options.title.text+"&nbsp;<i class='fa fa-check'></i></a></li>"):$("<li><a>Y-Axis: "+axis.options.title.text+"</a></li>").click(function(){dsc.moveAxis(series,axis,scope)}),$dropdown.append($menuItem)}),$dropdown.append($('<li><a><i class="fa fa-plus"></i> Move To New Axis</a></li>').click(function(){const axis=dsc.addAxisToChart(chart,series.name,scope,series.userOptions.axisType);dsc.moveAxis(series,axis,scope)})),$dropdown}}(),angular.module("decorated-stock-chart").run(["$templateCache",function($templateCache){$templateCache.put("DecoratedStockChart.html",'<div class="root" style="position: relative">\r\n    <div class="control flex-main-container"\r\n         ng-init="showSecurityControl = false; showIndicatorControl = false; showBenchmarkControl = false;">\r\n        <span class="flex-sub-container-left">\r\n            <!-- security & attributes selection -->\r\n            <span dsc-click-outside dsc-open-state="states.menuDisplays.securityControl"\r\n                  dsc-close-callback="toggleSlide(!states.menuDisplays.securityControl, \'security-control\')">\r\n                <span class="restrict-dropdown-menu">\r\n                    <input type="text" ng-model="defaultSecurityAttribute" class="form-control"\r\n                           style="width: 12em; display: inline; height:25px;"\r\n                           typeahead="attr as attr.label for attr in availableSecurityAttributes | filter:$viewValue:$emptyOrMatch | orderBy:\'label.toString()\'"\r\n                           typeahead-focus\r\n                           typeahead-select-on-blur="true"/>\r\n                </span>\r\n                <a><i ng-click="toggleSlide(!states.menuDisplays.securityControl, \'security-control\')"\r\n                      class="fa clickable"\r\n                      ng-class="{\'fa-chevron-up\': states.menuDisplays.securityControl, \'fa-chevron-down\': !states.menuDisplays.securityControl}"></i></a>\r\n                <div class="security-control floating-form" style="display: none;top:35px;left:0;">\r\n                    <div ng-show="states.securityAttrMap.length === 0">\r\n                        <h5>No Security Selected</h5>\r\n                    </div>\r\n                    <div class="flex-container">\r\n                        <span class="wrappable-flex-item" ng-repeat="securityAttrPair in states.securityAttrMap">\r\n                            <!-- selected attributes display -->\r\n                            <span class="label label-success">{{securityAttrPair[0].label}} | <i class="fa fa-remove clickable"\r\n                                                                                                 ng-click="apiHandle.api.removeSecurity(securityAttrPair[0].id)"></i></span>\r\n                            <span class="label label-primary" ng-repeat="attr in securityAttrPair[1]">\r\n                                    {{attr.label}} | <i class="fa fa-remove clickable"\r\n                                                        ng-click="removeAttr(attr, securityAttrPair)"></i>\r\n                            </span>\r\n                            <!-- input to select more attributes-->\r\n                            &nbsp;\r\n                            <input type="text"\r\n                                   placeholder="+ Attribute"\r\n                                   ng-model="selected"\r\n                                   typeahead="attr as attr.label for attr in availableSecurityAttributes | filter:$viewValue:$emptyOrMatch | orderBy:\'label.toString()\'"\r\n                                   class="form-control"\r\n                                   style="width: 8em; display: inline;"\r\n                                   typeahead-on-select="addAttr($item, securityAttrPair); selected = \'\'"\r\n                                   typeahead-focus>\r\n\r\n                        </span>\r\n                    </div>\r\n                </div>\r\n            </span>\r\n            <!-- TODO implement these date functionalities -->\r\n            <span style="padding-left:25px;">\r\n                <span class="clickable dsc-padding-right" ng-repeat="period in customDefaultTimePeriods" ng-click="selectTimePeriod(period)"\r\n                      style="padding-right:5px;color:#005da0;">\r\n                    {{period}}\r\n                </span>\r\n                <span style="color:#005da0;overflow: hidden"\r\n                      dsc-click-outside\r\n                      dsc-open-state="states.menuDisplays.dateControl"\r\n                      dsc-close-callback="toggleSlide(!states.menuDisplays.dateControl, \'date-control\')">\r\n                    <i class="fa fa-calendar clickable" ng-click="toggleSlide(!states.menuDisplays.dateControl, \'date-control\');\r\n                             start = states.dateRange.start.getYYYYMMDD();\r\n                             end = states.dateRange.end.getYYYYMMDD()"></i>\r\n                    <div class="date-control floating-form" style="display: none;">\r\n                        <alert ng-show="alerts.dateChangeError.active" close="alerts.dateChangeError.active = false" type="danger" style="font-size: 12px;">\r\n                            {{alerts.dateChangeError.message}}\r\n                            <br/>\r\n                            Format: YYYY-MM-DD\r\n                        </alert>\r\n                        <label>From&nbsp;</label>\r\n                        <div class="input-group limited-input">\r\n                            <input type="text" class="form-control"\r\n                                   datepicker-popup\r\n                                   is-open="startDatePickerOpen"\r\n                                   ng-model="start"\r\n                                   close-text="Close"/>\r\n                            <span class="input-group-btn">\r\n                                <button type="button" class="btn btn-default" ng-click="startDatePickerOpen = !startDatePickerOpen"><i class="fa fa-calendar"></i></button>\r\n                            </span>\r\n                        </div>\r\n                        <label>To&nbsp;</label>\r\n                        <div class="input-group limited-input">\r\n                            <input type="text" class="form-control"\r\n                                   datepicker-popup\r\n                                   is-open="endDatePickerOpen"\r\n                                   ng-model="end"\r\n                                   close-text="Close"/>\r\n                            <span class="input-group-btn">\r\n                                <button type="button" class="btn btn-default" ng-click="endDatePickerOpen = !endDatePickerOpen"><i class="fa fa-calendar"></i></button>\r\n                            </span>\r\n                        </div>\r\n                        <hr/>\r\n                        <button class="btn btn-success"\r\n                                ng-click="alerts.dateChangeError.message = apiHandle.api.changeDateRange(start, end);\r\n                                          alerts.dateChangeError.message ? null : showDateControl = !showDateControl;">\r\n                            <i class="fa fa-play"></i>\r\n                        </button>\r\n                    </div>\r\n                </span>\r\n            </span>\r\n        </span>\r\n        <span class="flex-sub-container-right">\r\n            <span dsc-click-outside dsc-open-state="states.menuDisplays.indicatorControl"\r\n                  dsc-close-callback="toggleSlide(!states.menuDisplays.indicatorControl,\'indicator-control\')">\r\n                <a class="clickable" style="text-decoration:none"\r\n                   ng-click="toggleSlide(!states.menuDisplays.indicatorControl,\'indicator-control\');selected=\'\';">\r\n                    <span class="fake-anchor-tag">Market Indicators</span>\r\n                    <i class="fa" ng-class="{\'fa-chevron-up\': states.menuDisplays.indicatorControl, \'fa-chevron-down\': !states.menuDisplays.indicatorControl}"></i>\r\n                </a>\r\n                <div class="indicator-control floating-form" style="display: none;width:250px;">\r\n                    <label>\r\n                        Search&nbsp;\r\n                    </label>\r\n                    <span class="restrict-dropdown-menu">\r\n                        <input type="text" placeholder="ex: S&P 500, Energy CDS..." class="form-control"\r\n                                   ng-model="selected"\r\n                                   typeahead="attr.label for attr in marketIndexTypeahead({userInput: $viewValue}) | filter:$viewValue:$emptyOrMatch | orderBy:\'label.toString()\'"\r\n                                   typeahead-on-select="apiHandle.api.addMarketIndicator($item); selected = \'\';showIndicatorControl = false;"\r\n                                   typeahead-focus/>\r\n                    </span>\r\n                    <a class="clickable" ng-if="showMoreMarketInfo" ng-click="moreMarketInfoCallback()">Show All</a>\r\n                </div>\r\n            </span>\r\n            <span dsc-click-outside dsc-open-state="states.menuDisplays.benchmarkControl"\r\n                  dsc-close-callback="toggleSlide(!states.menuDisplays.benchmarkControl, \'benchmark-control\')"\r\n                    style="padding-right:10px" ng-init="customBenchmark = {}">\r\n                <a class="clickable" style="padding-left:5px;text-decoration:none;"\r\n                   ng-click="toggleSlide(!states.menuDisplays.benchmarkControl, \'benchmark-control\');customBenchmark = {};">\r\n                    <span class="fake-anchor-tag">Benchmark</span>\r\n                    <i class="fa" ng-class="{\'fa-chevron-up\': states.menuDisplays.benchmarkControl, \'fa-chevron-down\': !states.menuDisplays.benchmarkControl}"></i>\r\n                </a>\r\n                <div class="benchmark-control floating-form" style="display: none;">\r\n                    <alert ng-show="alerts.customBenchmark.active" close="alerts.customBenchmark.active = false" type="danger" style="font-size: 12px;">\r\n                        There were problems with your input\r\n                        <br/><br/>\r\n                        <ul style="list-style:inside;padding-left:0;">\r\n                            <li ng-repeat="message in alerts.customBenchmark.messages">{{message}}</li>\r\n                        </ul>\r\n                    </alert>\r\n                    <label>\r\n                        Sector&nbsp;\r\n                        <span class="restrict-dropdown-menu-small">\r\n                            <input type="text" class="form-control length-md"\r\n                                   ng-model="customBenchmark.sector"\r\n                                   typeahead="sector for sector in customBenchmarkOptions.sectors | filter:$viewValue:$emptyOrMatch | orderBy:\'toString()\'"\r\n                                   typeahead-focus\r\n                                   typeahead-select-on-blur="true"/>\r\n                        </span>\r\n                    </label>\r\n                    <label>\r\n                        Rating&nbsp;\r\n                        <span class="restrict-dropdown-menu-small">\r\n                            <input type="text" class="form-control length-md"\r\n                                   ng-model="customBenchmark.rating"\r\n                                   typeahead="rating for rating in customBenchmarkOptions.ratings | filter:$viewValue:$emptyOrMatch | orderBy:\'toString()\'"\r\n                                   typeahead-focus\r\n                                   typeahead-select-on-blur="true"/>\r\n                        </span>\r\n                    </label>\r\n                    <label>\r\n                        WAL&nbsp;\r\n                        <span class="restrict-dropdown-menu-small">\r\n                            <input type="text" class="form-control length-md"\r\n                                   ng-model="customBenchmark.wal"\r\n                                   typeahead="wal for wal in customBenchmarkOptions.wal | filter:$viewValue:$emptyOrMatch | orderBy:sortWalBuckets"\r\n                                   typeahead-focus\r\n                                   typeahead-select-on-blur="true"/>\r\n                        </span>\r\n                    </label>\r\n                    <label>\r\n                        Analytic&nbsp;\r\n                        <span class="restrict-dropdown-menu-small">\r\n                            <input type="text" class="form-control length-md"\r\n                                   ng-model="customBenchmark.analytic"\r\n                                   typeahead="attr as attr.label for attr in customBenchmarkOptions.analytics | filter:$viewValue:$emptyOrMatch | orderBy:\'label.toString()\'"\r\n                                   typeahead-focus\r\n                                   typeahead-select-on-blur="true"/>\r\n                        </span>\r\n                    </label>\r\n                    <button class="btn btn-success" ng-click="apiHandle.api.addCustomBenchmark(customBenchmark)"><i\r\n                            class="fa fa-play"></i></button>\r\n                </div>\r\n            </span>\r\n            <span>\r\n                <span class="clickable" style="padding-right:5px;color:#005da0;" ng-click="exportXLS()"><i class="fa fa-share-square-o"></i></span>\r\n                <span class="clickable" style="padding-right:5px;color:#005da0;" ng-repeat="customButton in customButtons" ng-click="customButton.callback()">\r\n                    <i class="fa" ng-class="customButton.faClass"></i>\r\n                </span>\r\n            </span>\r\n        </span>\r\n    </div>\r\n    <hr/>\r\n    <div style="position:relative">\r\n        <i ng-show="isProcessing" class="fa fa-spinner fa-spin fa-3x spinner" style="position:absolute;top:0;left:0"></i>\r\n        <!-- this is where the stock chart goes -->\r\n        <div ng-attr-id="{{\'enriched-highstock-\'+id}}" style="width:100%;height:100%;"></div>\r\n        <alert ng-show="alerts.generalWarning.active" style="position:absolute;bottom:0;right:0;"\r\n               close="alerts.generalWarning.active = false" type="danger">\r\n            {{alerts.generalWarning.message}}\r\n        </alert>\r\n    </div>\r\n</div>\r\n');
}]);